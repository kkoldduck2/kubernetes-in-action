## 11장 쿠버네티스 내부 이해



### Kubelet?

Kubelet은 Kubernetes 클러스터의 워커노드에서 실행되는 핵심 에이전트로, **시스템 구성요소로 실행되며** 파드의 실행과 상태 관리, 리소스 모니터링 등의 핵심 기능을 수행합니다. 클러스터의 원활한 운영과 안정성을 보장하기 위해 보안에 특별히 신경 써야 하며, 올바르게 구성된 Kubelet은 클러스터의 가용성과 성능을 크게 향상시킨다.







---

### 컨트롤플레인 구성요소

감시매커니즘이란?

감시매커니즘을 활용하여 Kubelet에 직접 요청을 보내지않고 APIServer 를통해 리소스 상태값을 갱신하는 역할을 한다.



#### ETCD

영구적인 키-값 분산 데이터 저장소 이며 둘 이상의 인스턴스를 실행해 우수한 고가용성을 구성 할 수 있음

API 로만 접근이 가능하여 **낙관적잠금** 및 **유효성 검사**등의 이점을 얻을 수 있다.

* 낙관적 잠금 : 데이터에 번호를 포함하여 동시에 시도시 버전검사를 진행하므로 첫번째 요청만 수용됨.

* 합의알고리즘 : 과반수에 의한 결정을통해 ETCD 상태 결정



#### API Server

1)인증 플러그인 -> 2)인가 플러그인 -> 3)어드미션 컨트롤 플러그인 -> 4)리소스 유효성 검사의 과정을 거쳐 Kubectl 등의 클라이언트로 부터 ETCD 상태값 변경하는 역할

* 어드미션 컨트롤 플러그인 : AlwaysPullImage,SA,ResourceQuota 등 기본값 설정



오브젝트 갱신 시 API Server는 모든 연결된 클라이언트들에게 갱신된 오브젝트를 전달한다.(Kubectl, Fabric8 등)



#### Scheduler

스케줄러는 선택된 노드에 파드를 실행하도록 직접 지시하지않고 

**1)API Server로 파드 정의를 갱신하며** 이후 **2)API Server는 Kubelet에 파드가 스케줄링된것을 통보**한다. -> Kubelet이 컨테이너생성시작.



고려사항

* 퍼블릭 클라우드의경우 파드배치 vs 노드최소화

* 레플리카셋의경우 분산배치

* 상황별 스케줄러를 선택(schedulerName) 할 수 있는 다중 스케줄러 사용



#### Controller Manager

레플리카셋, 데몬셋, 디플로에먼트, 스테이트풀셋, 노드, 서비스, 엔드포인트, 네임스페이스, 퍼시스턴트볼륨 등 **대부분의 리소스에 해당하는 컨트롤러 





#### Kubelet

컨트롤 플레인의 구성요소로써 워커노드에서 실행하는 모든것을 담당하는 구성요소

* 실행중인 노드를 노드 리소스로 만들어서 API 서버에 등록하는것
* API서버를 지속적으로 모니터링하여 해당노드에 파드가 스케줄링되면 컨테이너 실행
* 설정된 컨테이너 런타임(Docker,rkt)등에 지정된 컨테이너 이미지로 컨테이너를 실행하도록 지시
* 실행중인 컨테이너를 모니터링하며 상태,이벤트,리소스 사용량을 API 서버에 보고(LivenessProbe?)



#### KubeProxy

* 서비스 IP Port로 들어온 요청을 서비시를 지원하는 파드중 하나와 연결시켜줌.(로드밸런싱 포함)



#### AddOn

* Nginx Ingress Controller(k8s service가 아닌 POD IP 직접호출)
* Kube-DNS



---





참고
